<!DOCTYPE html>
<html>
  <head>
    <script src="jquery.js"></script>
    <script src="data_generator.js"></script>
    <link rel="stylesheet" href="styles.css">
  </head>
  <body>
    <script>

      var visitor = prompt("Welcome to Twittler! What's your username?");

      $(document).ready(function(){

        streams.users[visitor] = [];

        //Used for stopping setTimeouts of both update & usertweet
        var timer;

        //Initial tweet displaying mechanism.
        var update = function(){
          var $body = $('.tweets');
          $body.html('');

          var index = streams.home.length - 1;
          while(index >= 0){
            var tweet = streams.home[index];

            var $tweet = $('<div class="tweets"></div>');
            var username = $('<div class="username" data-user=' + tweet.user + '>@' + tweet.user + '</div>');
            var message = $('<div class="message">' + tweet.message + '</div>');
            var timestamp = $('<div class="timestamp">' + tweet.created_at + '</div>');

            $tweet.append(username);
            $tweet.append(message);
            $tweet.append(timestamp);

            $tweet.appendTo($body);
            index -= 1;
          }
          timer = setTimeout(update, updateTime);
        };

        //For displaying specific user tweets.
        var userTweet = function(user){

          var $body = $('.tweets');
          $body.html('');
          $body.append('<h3>All tweets by @' + user + "</h3>");
          $body.append('<button class="back">Back</button>');

          var index = streams.users[user].length - 1;
          while(index >= 0){
            var tweet = streams.users[user][index];

            var $tweet = $('<div class="tweets"></div>');
            var message = $('<p class="message">' + tweet.message + '</p>');
            var timestamp = $('<p class="timestamp">' + tweet.created_at + '</p>');

            $tweet.append(message);
            $tweet.append(timestamp);

            $tweet.appendTo($body);
            index -= 1;
          }
          timer = setTimeout(function(){userTweet(user);}, updateTime);
        }

        //Default: tweets update every 3 seconds.
        var updateTime = 3000;

        $('.updatenow').on('click', update);

        //Allow user to set auto-update frequency.
        $('.updatetime').on('keypress', function(event){
          if(event.keyCode == 13){
            var ms = Number($(this).val());
            if(ms){
              updateTime = ms * 1000;
              clearTimeout(timer);
              update();
            }else{
              alert("Error: Not a valid number!");
            }
            $(this).blur();
          }
        });

        //Shows all tweets by the user when the user name is clicked.
        $('.tweets').on('click', '.username', function(){
          clearTimeout(timer);
          console.log("clicked");
          userTweet($(this).data('user'));
        });

        $('.tweets').on('click', '.back', function(){
          clearTimeout(timer);
          update();
        });

        //$('.input').on('')

        $('.enter').on('click', function(){
          var newTweet = $('.input').val();
          writeTweet(newTweet);
        });

        //Initial display of tweets upon opening page.
        update();

      });

    </script>

    <h1>Twittler by Marco Au</h1>
    <br>
    <input class="input" type="text" value="Enter your tweet here!"></input>
    <button class="enter">Enter</button>
    <br>
    Auto-update every: <input class="updatetime" type="number" value='3'></input>seconds <button class="updatenow">Update now!</button>
    <div class="tweets"></div>

  </body>
</html>
